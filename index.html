<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodFlow - Camp Food Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #F3F4F6; }
        
        /* Smooth Sidebar */
        .sidebar { background-color: #1F2937; color: white; transition: all 0.3s; }
        .nav-item { transition: all 0.2s; border-radius: 12px; margin-bottom: 5px; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background-color: #374151; color: #F472B6; padding-left: 1rem; }
        
        .stat-card { border-radius: 20px; transition: transform 0.2s; border: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stat-card:hover { transform: translateY(-3px); }
        
        /* Mobile Fixes */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 70px; flex-direction: row; z-index: 50; padding: 0 10px; justify-content: space-around; border-radius: 20px 20px 0 0; }
            .sidebar h1, .nav-text, .logout-txt { display: none; }
            .main-content { margin-bottom: 80px; }
        }
        
        .loader { border-top-color: #F472B6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
    </div>

    <div id="login-view" class="flex-grow flex items-center justify-center bg-gray-900 px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-pink-500 rounded-2xl mx-auto flex items-center justify-center mb-3">
                    <i class="fas fa-utensils text-white text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">FoodFlow</h2>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" class="w-full px-4 py-3 rounded-xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-500" placeholder="Email" required>
                <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-xl bg-gray-100 border-none outline-none focus:ring-2 focus:ring-pink-500" placeholder="Password" required>
                <button type="submit" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg">Sign In</button>
            </form>
            <div class="mt-6 text-center border-t pt-4">
                <button onclick="showSetupModal()" class="text-pink-600 text-sm font-semibold hover:underline">Initialize Super Admin</button>
            </div>
        </div>
    </div>

    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">System Setup</h3>
            <input type="password" id="setup-code" placeholder="Passcode (200431504082)" class="w-full px-4 py-3 rounded-xl bg-gray-100 mb-3 outline-none">
            <div id="setup-form" class="hidden space-y-3">
                <input type="email" id="sa-email" placeholder="New Admin Email" class="w-full px-4 py-3 rounded-xl bg-gray-100 outline-none">
                <input type="password" id="sa-pass" placeholder="New Password" class="w-full px-4 py-3 rounded-xl bg-gray-100 outline-none">
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="verifySetupCode()" id="verify-btn" class="flex-1 bg-pink-500 text-white py-2 rounded-xl font-bold">Verify</button>
                <button onclick="createSuperAdmin()" id="create-sa-btn" class="hidden flex-1 bg-green-500 text-white py-2 rounded-xl font-bold">Create</button>
                <button onclick="document.getElementById('setup-modal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl font-bold">Cancel</button>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden flex h-screen bg-[#F3F4F6]">
        <div class="sidebar w-64 flex flex-col py-6 px-4 md:h-full h-auto flex-shrink-0">
            <div class="flex items-center gap-3 px-2 mb-8 md:flex hidden">
                <div class="w-8 h-8 bg-pink-500 rounded-lg flex items-center justify-center"><i class="fas fa-utensils text-white text-xs"></i></div>
                <h1 class="text-xl font-bold tracking-wide">FoodFlow</h1>
            </div>
            <nav class="flex-1 flex md:flex-col flex-row md:gap-2 gap-1 overflow-x-auto md:overflow-visible no-scrollbar">
                <div onclick="switchTab('dashboard')" class="nav-item active flex items-center p-3"><i class="fas fa-home w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Dashboard</span></div>
                <div onclick="switchTab('sessions')" class="nav-item flex items-center p-3"><i class="fas fa-clock w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Sessions</span></div>
                <div onclick="switchTab('registration')" class="nav-item flex items-center p-3"><i class="fas fa-users w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Registration</span></div>
                <div onclick="switchTab('ids')" class="nav-item flex items-center p-3"><i class="fas fa-id-card w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">ID Cards</span></div>
                <div onclick="switchTab('staff')" class="nav-item flex items-center p-3"><i class="fas fa-user-shield w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Staff</span></div>
                <div onclick="switchTab('reports')" class="nav-item flex items-center p-3"><i class="fas fa-file-alt w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Reports</span></div>
                <div onclick="switchTab('settings')" class="nav-item flex items-center p-3"><i class="fas fa-cog w-6 text-center"></i> <span class="nav-text font-medium text-sm ml-3">Settings</span></div>
            </nav>
            <div class="md:block hidden mt-auto">
                 <button onclick="logout()" class="w-full bg-gray-700 p-3 rounded-xl flex items-center gap-3 hover:bg-red-500 transition"><i class="fas fa-sign-out-alt"></i> <span class="logout-txt">Logout</span></button>
            </div>
        </div>

        <main class="main-content flex-1 overflow-y-auto p-4 md:p-8 ml-0">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="page-title">Dashboard</h2>
                <button onclick="logout()" class="md:hidden w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-red-500"><i class="fas fa-sign-out-alt"></i></button>
            </header>

            <div id="tab-dashboard" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white p-6">
                        <div class="p-3 bg-pink-100 rounded-xl text-pink-600 w-max mb-4"><i class="fas fa-users"></i></div>
                        <h3 class="text-3xl font-bold" id="stat-total-members">0</h3>
                        <p class="text-xs text-gray-400 uppercase">Registered Members</p>
                    </div>
                     <div class="stat-card bg-white p-6">
                        <div class="p-3 bg-blue-100 rounded-xl text-blue-600 w-max mb-4"><i class="fas fa-utensils"></i></div>
                        <h3 class="text-3xl font-bold" id="stat-issued-today">0</h3>
                        <p class="text-xs text-gray-400 uppercase">Total Meals Issued</p>
                    </div>
                     <div class="stat-card bg-white p-6">
                        <div class="p-3 bg-yellow-100 rounded-xl text-yellow-600 w-max mb-4"><i class="fas fa-clock"></i></div>
                        <h3 class="text-3xl font-bold" id="stat-active-sessions">0</h3>
                        <p class="text-xs text-gray-400 uppercase">Active Sessions</p>
                    </div>
                    <div class="stat-card bg-white p-6">
                        <div class="p-3 bg-green-100 rounded-xl text-green-600 w-max mb-4"><i class="fas fa-chart-pie"></i></div>
                        <h3 class="text-3xl font-bold" id="stat-coverage">0%</h3>
                        <p class="text-xs text-gray-400 uppercase">Overall Coverage</p>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Session Breakdown</h3>
                <div id="session-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="tab-sessions" class="tab-content hidden">
                <div class="bg-white p-6 rounded-3xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg mb-4">Add Session</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="sess-name" placeholder="Session Name (e.g., Day 1 Lunch)" class="flex-1 p-3 bg-gray-50 rounded-xl outline-none">
                        <input type="number" id="sess-count" placeholder="Expected Count" class="w-32 p-3 bg-gray-50 rounded-xl outline-none">
                        <button onclick="addSession()" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold">Add</button>
                    </div>
                </div>
                <div id="sessions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="tab-registration" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Add Committee</h3>
                        <div class="flex gap-2">
                            <input type="text" id="new-committee-name" placeholder="Name" class="w-full p-2 bg-gray-50 rounded-lg outline-none">
                            <button onclick="addCommittee()" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="committee-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto text-sm"></div>
                    </div>
                    <div class="md:col-span-2 bg-white p-6 rounded-3xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Register Member</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="reg-name" placeholder="Full Name" class="p-3 bg-gray-50 rounded-xl outline-none">
                            <select id="reg-committee" class="p-3 bg-gray-50 rounded-xl outline-none"><option>Select Committee</option></select>
                            <select id="reg-type" class="p-3 bg-gray-50 rounded-xl outline-none">
                                <option value="Non-Veg">Non-Veg</option>
                                <option value="Veg">Veg</option>
                            </select>
                            <button onclick="registerMember()" class="bg-pink-500 text-white font-bold p-3 rounded-xl">Register</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Members</h3>
                        <input type="text" id="search-member" onkeyup="filterMembers()" placeholder="Search..." class="p-2 bg-gray-50 rounded-lg text-sm border">
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">ID</th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3">Committee</th>
                                    <th class="px-4 py-3">Type</th>
                                    <th class="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-ids" class="tab-content hidden">
                <div class="bg-white p-6 rounded-3xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Download ID Cards (A4)</h3>
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <select id="id-print-committee" class="p-3 bg-gray-50 rounded-xl w-full md:w-64 outline-none"></select>
                        <button onclick="generateIDPDF()" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold w-full md:w-auto"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
                    </div>
                    <div id="id-loading" class="hidden mt-4 text-pink-600 text-sm font-bold"><i class="fas fa-spinner fa-spin"></i> Generating PDF, please wait...</div>
                </div>
            </div>

            <div id="tab-staff" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-3xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg mb-4">Create Staff</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="email" id="staff-email" placeholder="Email" class="p-3 bg-gray-50 rounded-xl outline-none">
                        <input type="password" id="staff-pass" placeholder="Password" class="p-3 bg-gray-50 rounded-xl outline-none">
                        <select id="staff-role" class="p-3 bg-gray-50 rounded-xl outline-none"><option value="scanner">Scanner</option><option value="admin">Admin</option></select>
                        <button onclick="createStaffUser()" class="bg-gray-900 text-white font-bold p-3 rounded-xl">Create</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">* Note: Creating staff requires a fresh login in current Firebase setup.</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Existing Staff</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-4 py-3">Email</th>
                                    <th class="px-4 py-3">Role</th>
                                    <th class="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="staff-list-body">
                                <tr><td colspan="3" class="text-center py-4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-reports" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-3xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Data Export</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border p-6 rounded-xl cursor-pointer hover:bg-gray-50 transition" onclick="exportFullBackup()">
                            <i class="fas fa-file-archive text-4xl text-yellow-500 mb-2"></i>
                            <h4 class="font-bold">Full Backup (ZIP)</h4>
                        </div>
                         <div class="border p-6 rounded-xl cursor-pointer hover:bg-gray-50 transition">
                            <i class="fas fa-file-excel text-4xl text-green-500 mb-2"></i>
                            <h4 class="font-bold">Session Report (Excel)</h4>
                            <select id="report-session-select" class="mt-2 w-full p-2 border rounded text-sm" onchange="if(this.value) exportSessionReport(this.value)">
                                <option value="">Select Session to Download</option>
                            </select>
                        </div>
                    </div>
                 </div>
            </div>

            <div id="tab-settings" class="tab-content hidden">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-red-100">
                    <h3 class="font-bold text-lg text-red-600 mb-4">Danger Zone</h3>
                    <p class="text-sm text-gray-500 mb-4">This will permanently delete all data. Action cannot be undone.</p>
                    <button onclick="systemReset()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700">Reset System Data</button>
                </div>
            </div>
        </main>
    </div>

    <div id="scanner-view" class="hidden h-screen bg-gray-900 flex flex-col items-center">
        <div class="w-full bg-gray-800 p-4 rounded-b-3xl shadow-lg z-10">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-white font-bold">Scanner</h2>
                 <button onclick="logout()" class="text-gray-400"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <select id="scanner-session-select" class="w-full bg-gray-700 text-white p-3 rounded-xl outline-none"><option value="">Select Session...</option></select>
        </div>
        <div class="flex-1 w-full flex flex-col items-center justify-center p-4">
            <div id="qr-reader" class="w-full max-w-sm bg-black rounded-3xl overflow-hidden shadow-2xl border-4 border-gray-700 relative"></div>
            <button onclick="document.getElementById('manual-input-modal').classList.remove('hidden')" class="mt-6 bg-gray-700 text-white px-6 py-2 rounded-full text-sm font-medium">Manual Input</button>
        </div>
        
        <div id="scan-result-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center">
                <div id="result-content"></div>
                <button onclick="document.getElementById('scan-result-modal').classList.add('hidden')" class="mt-4 w-full bg-gray-200 py-3 rounded-xl font-bold">Close</button>
            </div>
        </div>
        <div id="manual-input-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6">
                <h3 class="text-lg font-bold mb-4">Enter Member ID</h3>
                <input type="text" id="manual-id-input" placeholder="e.g., CS/01" class="w-full p-4 bg-gray-100 rounded-xl text-xl text-center font-mono uppercase mb-4">
                <button onclick="processScan(document.getElementById('manual-id-input').value.toUpperCase())" class="w-full bg-pink-500 text-white py-3 rounded-xl font-bold mb-2">Check</button>
                <button onclick="document.getElementById('manual-input-modal').classList.add('hidden')" class="w-full bg-gray-200 py-3 rounded-xl font-bold">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update, remove, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCoUCetU0lnfsUoDNxiaFvLZGkkSUC9cn8",
            authDomain: "foodmgr-8cb0d.firebaseapp.com",
            databaseURL: "https://foodmgr-8cb0d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "foodmgr-8cb0d",
            storageBucket: "foodmgr-8cb0d.firebasestorage.app",
            messagingSenderId: "454726717108",
            appId: "1:454726717108:web:569d07ac643c44bcad51e1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;
        let scanLock = false;

        // --- NAVIGATION ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Dynamic Data Load
            if(tab === 'registration') loadCommitteesAndMembers();
            if(tab === 'ids') loadCommitteesForIDs();
            if(tab === 'staff') loadStaffList(); // Added this
            if(tab === 'dashboard') initAdminDashboard();
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            if(user) {
                currentUser = user;
                const snap = await get(child(ref(db), `users/${user.uid}`));
                if(snap.exists()) {
                    const role = snap.val().role;
                    loader.classList.add('hidden');
                    document.getElementById('login-view').classList.add('hidden');
                    if(role === 'admin') {
                        document.getElementById('admin-view').classList.remove('hidden');
                        initAdminDashboard();
                    } else {
                        document.getElementById('scanner-view').classList.remove('hidden');
                        initScanner();
                    }
                } else { loader.classList.add('hidden'); Swal.fire('Error', 'No User Data Found', 'error'); }
            } else {
                loader.classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('admin-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
            } catch(e) { 
                document.getElementById('loader').classList.add('hidden');
                Swal.fire('Error', 'Login Failed. Check credentials.', 'error');
            }
        });

        // --- STAFF MANAGEMENT (FIXED) ---
        window.createStaffUser = async () => {
            const email = document.getElementById('staff-email').value;
            const pass = document.getElementById('staff-pass').value;
            const role = document.getElementById('staff-role').value;
            
            if(!email || !pass) return Swal.fire('Missing Data', 'Please fill email and password', 'warning');

            try {
                // Warning: Creating user logs out current user in standard Firebase Auth.
                const uc = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, 'users/' + uc.user.uid), { email, role });
                Swal.fire('Success', 'Staff Created! You will be logged out to verify.', 'success').then(() => location.reload());
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.loadStaffList = () => {
            const tbody = document.getElementById('staff-list-body');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Loading...</td></tr>';
            
            onValue(ref(db, 'users'), (snapshot) => {
                const users = snapshot.val() || {};
                tbody.innerHTML = '';
                if(Object.keys(users).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No staff found.</td></tr>';
                    return;
                }
                
                Object.entries(users).forEach(([uid, user]) => {
                    tbody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-3">${user.email}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${user.role==='admin'?'bg-purple-100 text-purple-600':'bg-blue-100 text-blue-600'}">${user.role.toUpperCase()}</span></td>
                            <td class="px-4 py-3">
                                ${user.role !== 'admin' ? `<button onclick="removeStaff('${uid}')" class="text-red-500 hover:text-red-700 font-medium">Remove</button>` : ''}
                            </td>
                        </tr>
                    `;
                });
            });
        };
        
        window.removeStaff = (uid) => {
            Swal.fire({
                title: 'Remove Staff?',
                text: "This removes database access but not the Auth account (requires Firebase Admin SDK).",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove'
            }).then((result) => {
                if(result.isConfirmed) {
                    remove(ref(db, `users/${uid}`));
                }
            });
        };

        // --- SYSTEM RESET (SECURE) ---
        window.systemReset = async () => {
            const { value: password } = await Swal.fire({
                title: 'Enter Admin Password',
                input: 'password',
                inputLabel: 'Password required to reset system',
                inputPlaceholder: 'Enter your password',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'RESET EVERYTHING'
            });

            if (password === "200431504082") {
                document.getElementById('loader').classList.remove('hidden');
                // Remove Members, Sessions, Logs, Committees
                const updates = {};
                updates['members'] = null;
                updates['sessions'] = null;
                updates['logs'] = null;
                updates['committees'] = null;
                
                await update(ref(db), updates);
                document.getElementById('loader').classList.add('hidden');
                Swal.fire('Reset Complete', 'System has been wiped.', 'success').then(() => location.reload());
            } else if (password) {
                Swal.fire('Access Denied', 'Incorrect Password', 'error');
            }
        };

        // --- DASHBOARD & SESSIONS ---
        function initAdminDashboard() {
            onValue(ref(db), (snapshot) => {
                const data = snapshot.val() || {};
                const members = data.members || {};
                const sessions = data.sessions || {};
                const logs = data.logs || {};
                
                const totalMembers = Object.keys(members).length;
                let totalIssued = 0;
                let activeCount = 0;
                
                const grid = document.getElementById('session-stats-grid');
                grid.innerHTML = '';
                const reportSelect = document.getElementById('report-session-select');
                reportSelect.innerHTML = '<option value="">Select Session to Download</option>';

                for (const [sid, sess] of Object.entries(sessions)) {
                    if(sess.active) activeCount++;
                    const sessLogs = logs[sid] || {};
                    const issued = Object.keys(sessLogs).length;
                    totalIssued += issued;

                    const quota = parseInt(sess.expected) || 0;
                    const remaining = quota - issued;
                    const isDeficit = remaining < 0;
                    
                    grid.innerHTML += `
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 ${sess.active ? 'border-green-500' : 'border-gray-300'}">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-lg">${sess.name}</h4>
                                <span class="text-xs font-bold px-2 py-1 rounded ${sess.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">${sess.active ? 'LIVE' : 'CLOSED'}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-500 mb-2">
                                <span>Quota: ${quota}</span>
                                <span>Issued: <strong class="text-gray-800">${issued}</strong></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-pink-500 h-2 rounded-full" style="width: ${Math.min((issued/quota)*100, 100)}%"></div>
                            </div>
                            <div class="mt-3 p-2 ${isDeficit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} rounded text-center text-sm font-bold">
                                ${isDeficit ? `Excess: ${Math.abs(remaining)}` : `Remaining: ${remaining}`}
                            </div>
                            <button onclick="deleteSession('${sid}')" class="mt-4 text-xs text-red-400 hover:text-red-600 underline">Delete</button>
                        </div>
                    `;
                    reportSelect.innerHTML += `<option value="${sid}">${sess.name}</option>`;
                }

                document.getElementById('stat-total-members').innerText = totalMembers;
                document.getElementById('stat-issued-today').innerText = totalIssued;
                document.getElementById('stat-active-sessions').innerText = activeCount;
                document.getElementById('stat-coverage').innerText = totalMembers > 0 ? Math.round((totalIssued / (totalMembers * Object.keys(sessions).length || 1)) * 100) + '%' : '0%';
                
                // Populate Sessions List in Session Tab
                const sList = document.getElementById('sessions-list');
                const scannerSel = document.getElementById('scanner-session-select');
                sList.innerHTML = '';
                scannerSel.innerHTML = '<option value="">Select Session...</option>';
                
                for(const [id, d] of Object.entries(sessions)) {
                    sList.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border flex justify-between items-center">
                            <div>
                                <h4 class="font-bold">${d.name}</h4>
                                <span class="text-xs text-gray-500">Exp: ${d.expected}</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" onchange="toggleSession('${id}', this.checked)" ${d.active ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    `;
                    if(d.active) scannerSel.innerHTML += `<option value="${id}">${d.name}</option>`;
                }
            });
        }

        window.addSession = () => {
            const name = document.getElementById('sess-name').value;
            const count = document.getElementById('sess-count').value;
            if(name) push(ref(db, 'sessions'), { name, expected: count, active: false });
        };
        window.toggleSession = (id, val) => update(ref(db, `sessions/${id}`), { active: val });
        window.deleteSession = (id) => {
            if(confirm("Delete this session and its logs?")) {
                remove(ref(db, `sessions/${id}`));
                remove(ref(db, `logs/${id}`));
            }
        };

        // --- MEMBERS & COMMITTEES ---
        window.addCommittee = () => {
            const n = document.getElementById('new-committee-name').value;
            if(n) push(ref(db, 'committees'), { name: n });
            document.getElementById('new-committee-name').value = '';
        };

        function loadCommitteesAndMembers() {
            onValue(ref(db, 'committees'), s => {
                const l = document.getElementById('committee-list');
                const sel = document.getElementById('reg-committee');
                l.innerHTML = ''; sel.innerHTML = '<option>Select Committee</option>';
                const d = s.val() || {};
                for(const [k, v] of Object.entries(d)) {
                    sel.innerHTML += `<option value="${v.name}">${v.name}</option>`;
                    l.innerHTML += `<div class="p-2 bg-gray-50 rounded flex justify-between"><span>${v.name}</span> <i class="fas fa-trash text-red-300 cursor-pointer" onclick="remove(ref(db, 'committees/${k}'))"></i></div>`;
                }
            });
            onValue(ref(db, 'members'), s => {
                const b = document.getElementById('members-table-body');
                b.innerHTML = '';
                const m = s.val() || {};
                window.allMembers = m; // Cache for search
                renderMembers(m);
            });
        }
        
        function renderMembers(m) {
             const b = document.getElementById('members-table-body');
             b.innerHTML = '';
             for(const [k, v] of Object.entries(m)) {
                b.innerHTML += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-mono font-bold">${v.id}</td>
                        <td class="px-4 py-3">${v.name}</td>
                        <td class="px-4 py-3">${v.committee}</td>
                        <td class="px-4 py-3 text-${v.type==='Veg'?'green':'red'}-600 font-bold">${v.type}</td>
                        <td class="px-4 py-3"><button onclick="remove(ref(db, 'members/${k}'))" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            }
        }

        window.filterMembers = () => {
            const term = document.getElementById('search-member').value.toLowerCase();
            const filtered = {};
            for(const [k, v] of Object.entries(window.allMembers || {})) {
                if(v.name.toLowerCase().includes(term) || v.id.toLowerCase().includes(term)) filtered[k] = v;
            }
            renderMembers(filtered);
        }

        window.registerMember = async () => {
            const name = document.getElementById('reg-name').value;
            const com = document.getElementById('reg-committee').value;
            const type = document.getElementById('reg-type').value;
            if(name && com !== 'Select Committee') {
                const snap = await get(ref(db, 'members'));
                const count = snap.exists() ? Object.keys(snap.val()).length + 1 : 1;
                const id = `CS/${String(count).padStart(2,'0')}`;
                await set(ref(db, `members/${id.replace('/','_')}`), { id, name, committee: com, type });
                Swal.fire('Registered', `${name} (${id})`, 'success');
                document.getElementById('reg-name').value = '';
            } else { Swal.fire('Error', 'Fill all fields', 'warning'); }
        };

        // --- PDF ID GENERATION (FIXED QR) ---
        window.loadCommitteesForIDs = () => {
             onValue(ref(db, 'committees'), snap => {
                 const comms = snap.val() || {};
                 const sel = document.getElementById('id-print-committee');
                 sel.innerHTML = '';
                 for(const [id, d] of Object.entries(comms)) sel.innerHTML += `<option value="${d.name}">${d.name}</option>`;
            });
        }

        window.generateIDPDF = async () => {
            const committee = document.getElementById('id-print-committee').value;
            if(!committee) return Swal.fire('Select Committee', '', 'warning');
            
            document.getElementById('id-loading').classList.remove('hidden');

            const snap = await get(ref(db, 'members'));
            const members = Object.values(snap.val() || {}).filter(m => m.committee === committee);
            
            if(members.length === 0) {
                document.getElementById('id-loading').classList.add('hidden');
                return Swal.fire('No Members', 'No members found in this committee', 'info');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const cardW = 90, cardH = 55; // Standard ID size
            let x = 10, y = 10;

            for (let i = 0; i < members.length; i++) {
                const m = members[i];
                
                // Draw Card Border
                doc.setDrawColor(200);
                doc.rect(x, y, cardW, cardH);
                
                // Header
                doc.setFillColor(236, 72, 153); // Pink
                doc.rect(x, y, cardW, 12, 'F');
                doc.setTextColor(255);
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("FOODFLOW CAMP", x + cardW/2, y + 8, { align: 'center' });

                // Content
                doc.setTextColor(0);
                
                // Generate QR Code using correct library
                try {
                    const qrDataUrl = await QRCode.toDataURL(m.id, { margin: 1 });
                    doc.addImage(qrDataUrl, 'PNG', x + 5, y + 15, 30, 30);
                } catch(e) { console.error(e); }

                doc.setFontSize(14);
                doc.text(m.id, x + 60, y + 25, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                const splitName = doc.splitTextToSize(m.name, 50);
                doc.text(splitName, x + 60, y + 35, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(m.type === 'Veg' ? 'green' : 'red');
                doc.text(m.type.toUpperCase(), x + 60, y + 48, { align: 'center' });

                // Positioning for next card (2 columns, 5 rows)
                if (i % 2 === 0) {
                    x += cardW + 5; 
                } else {
                    x = 10; 
                    y += cardH + 5;
                }
                
                if (y > 280) { // New Page
                    doc.addPage();
                    x = 10; y = 10;
                }
            }
            
            doc.save(`${committee}_IDs.pdf`);
            document.getElementById('id-loading').classList.add('hidden');
        };

        // --- SCANNER LOGIC ---
        function initScanner() {
            onValue(ref(db, 'sessions'), snap => {
                const sess = snap.val() || {};
                const sel = document.getElementById('scanner-session-select');
                sel.innerHTML = '<option value="">Select Session...</option>';
                for(const [id, d] of Object.entries(sess)) if(d.active) sel.innerHTML += `<option value="${id}">${d.name}</option>`;
            });

            const qr = new Html5Qrcode("qr-reader");
            qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                async (txt) => {
                    if(scanLock) return;
                    scanLock = true;
                    await processScan(txt);
                    setTimeout(() => scanLock = false, 2500);
                }
            );
        }

        window.processScan = async (rawID) => {
            const sessId = document.getElementById('scanner-session-select').value;
            if(!sessId) { Swal.fire('Select Session', '', 'warning'); return; }
            
            const id = rawID.trim();
            const key = id.replace('/','_');
            const memSnap = await get(child(ref(db, 'members'), key));
            
            if(!memSnap.exists()) {
                showScanModal('error', 'Invalid ID', id);
                return;
            }
            const m = memSnap.val();
            
            const logRef = child(ref(db, `logs/${sessId}`), key);
            const logSnap = await get(logRef);
            
            if(logSnap.exists()) {
                const t = new Date(logSnap.val().timestamp).toLocaleTimeString();
                showScanModal('warning', 'ALREADY TAKEN', `Issued at ${t}`);
            } else {
                showScanModal('success', m.name, `${m.committee} | ${m.type}`, () => {
                    set(logRef, { timestamp: Date.now(), scanner: currentUser.uid });
                    document.getElementById('scan-result-modal').classList.add('hidden');
                    const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
                    Toast.fire({icon: 'success', title: 'Meal Issued'});
                });
            }
        };

        function showScanModal(type, title, msg, cb) {
            const m = document.getElementById('scan-result-modal');
            const c = document.getElementById('result-content');
            const color = type==='success'?'text-green-500':(type==='warning'?'text-yellow-500':'text-red-500');
            const icon = type==='success'?'fa-check-circle':(type==='warning'?'fa-exclamation-triangle':'fa-times-circle');
            
            let btn = cb ? `<button id="issue-conf-btn" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold mt-4 animate-pulse">ISSUE MEAL</button>` : '';
            c.innerHTML = `<i class="fas ${icon} ${color} text-6xl mb-4"></i><h3 class="text-2xl font-bold">${title}</h3><p class="text-gray-500">${msg}</p>${btn}`;
            m.classList.remove('hidden');
            if(cb) document.getElementById('issue-conf-btn').onclick = cb;
        }

        // --- UTILS ---
        window.showSetupModal = () => document.getElementById('setup-modal').classList.remove('hidden');
        window.verifySetupCode = () => {
            if(document.getElementById('setup-code').value === "200431504082") {
                document.getElementById('setup-form').classList.remove('hidden');
                document.getElementById('verify-btn').classList.add('hidden');
                document.getElementById('create-sa-btn').classList.remove('hidden');
            } else Swal.fire('Error', 'Invalid Code', 'error');
        };
        window.createSuperAdmin = async () => {
            const email = document.getElementById('sa-email').value;
            const pass = document.getElementById('sa-pass').value;
            try {
                const uc = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, 'users/' + uc.user.uid), { email, role: 'admin' });
                location.reload();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.exportFullBackup = async () => {
            const d = (await get(ref(db))).val();
            const z = new JSZip();
            z.file("db.json", JSON.stringify(d, null, 2));
            saveAs(await z.generateAsync({type:"blob"}), "backup.zip");
        };
        window.exportSessionReport = async (sid) => {
            const logs = (await get(child(ref(db), `logs/${sid}`))).val() || {};
            const mems = (await get(ref(db, 'members'))).val() || {};
            const data = Object.entries(logs).map(([k, v]) => {
                const m = mems[k] || {name:'Unknown', committee:'-'};
                return { ID: k, Name: m.name, Committee: m.committee, Time: new Date(v.timestamp).toLocaleString() };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, "session_report.xlsx");
        };
        
        window.remove = remove; window.ref = ref; window.db = db;
    </script>
</body>
</html>